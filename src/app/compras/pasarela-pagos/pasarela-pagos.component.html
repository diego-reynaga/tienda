<app-cabecero/>

<div class="payment-container py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">
        
        <!-- Pasos del proceso - Mejorado con iconos y animación -->
        <div class="stepper-container mb-5">
          <div class="stepper">
            <div class="step" [class.active]="currentStep >= 1">
              <div class="step-icon">
                <i class="bi bi-person-fill"></i>
              </div>
              <div class="step-text">Datos personales</div>
            </div>
            <div class="step-connector" [class.active]="currentStep >= 2"></div>
            <div class="step" [class.active]="currentStep >= 2">
              <div class="step-icon">
                <i class="bi bi-credit-card-fill"></i>
              </div>
              <div class="step-text">Pago</div>
            </div>
            <div class="step-connector" [class.active]="currentStep >= 3"></div>
            <div class="step" [class.active]="currentStep >= 3">
              <div class="step-icon">
                <i class="bi bi-check-circle-fill"></i>
              </div>
              <div class="step-text">Confirmación</div>
            </div>
            <div class="step-connector" [class.active]="currentStep >= 4"></div>
            <div class="step" [class.active]="currentStep >= 4">
              <div class="step-icon">
                <i class="bi bi-clock-fill"></i>
              </div>
              <div class="step-text">Estado</div>
            </div>
          </div>
        </div>

        <!-- Paso 1: Datos personales -->
        @if (currentStep === 1) {
          <div class="card payment-card border-0 shadow-lg animate__animated animate__fadeIn">
            <div class="card-header bg-gradient py-3">
              <h3 class="mb-0"><i class="bi bi-person-fill me-2"></i>Datos personales</h3>
            </div>
            <div class="card-body p-4">
              <form [formGroup]="datosForm">
                <div class="mb-4">
                  <label for="dni" class="form-label">DNI</label>
                  <div class="input-group input-group-lg">
                    <span class="input-group-text bg-transparent text-light border-dark">
                      <i class="bi bi-card-text"></i>
                    </span>
                    <input 
                      type="text" 
                      class="form-control form-control-lg bg-dark text-light border-dark" 
                      id="dni" 
                      formControlName="dni"
                      placeholder="Ingresa tu DNI (8 dígitos)" 
                      maxlength="8"
                      [class.is-invalid]="submitted && datosForm.get('dni')?.invalid"
                    >
                    <button 
                      class="btn btn-primary" 
                      type="button" 
                      [disabled]="datosForm.get('dni')?.invalid" 
                      (click)="verificarDNI()"
                    >
                      <i class="bi bi-search me-1"></i> Verificar
                    </button>
                  </div>
                  @if (submitted && datosForm.get('dni')?.errors) {
                    <div class="text-danger mt-2 animate__animated animate__fadeIn">
                      @if (datosForm.get('dni')?.errors?.['required']) {
                        <small><i class="bi bi-exclamation-triangle-fill me-1"></i>El DNI es requerido</small>
                      }
                      @if (datosForm.get('dni')?.errors?.['pattern']) {
                        <small><i class="bi bi-exclamation-triangle-fill me-1"></i>El DNI debe contener 8 dígitos numéricos</small>
                      }
                    </div>
                  }
                  @if (dniVerificado) {
                    <div class="text-success mt-2 animate__animated animate__fadeIn">
                      <i class="bi bi-check-circle-fill me-1"></i> DNI verificado correctamente
                    </div>
                  }
                  @if (dniError) {
                    <div class="text-danger mt-2 animate__animated animate__fadeIn">
                      <i class="bi bi-x-circle-fill me-1"></i> {{ dniError }}
                    </div>
                  }
                </div>

                <!-- Campos autocompletados después de verificar el DNI -->
                @if (dniVerificado) {
                  <div class="row animate__animated animate__fadeIn">
                    <div class="col-md-6 mb-3">
                      <label for="nombres" class="form-label">Nombres</label>
                      <div class="input-group">
                        <span class="input-group-text bg-transparent text-light border-dark">
                          <i class="bi bi-person"></i>
                        </span>
                        <input 
                          type="text" 
                          class="form-control bg-dark text-light border-dark" 
                          id="nombres" 
                          formControlName="nombres"
                          readonly
                        >
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="primerApellido" class="form-label">Primer Apellido</label>
                      <div class="input-group">
                        <span class="input-group-text bg-transparent text-light border-dark">
                          <i class="bi bi-person"></i>
                        </span>
                        <input 
                          type="text" 
                          class="form-control bg-dark text-light border-dark" 
                          id="primerApellido" 
                          formControlName="primerApellido"
                          readonly
                        >
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="segundoApellido" class="form-label">Segundo Apellido</label>
                      <div class="input-group">
                        <span class="input-group-text bg-transparent text-light border-dark">
                          <i class="bi bi-person"></i>
                        </span>
                        <input 
                          type="text" 
                          class="form-control bg-dark text-light border-dark" 
                          id="segundoApellido" 
                          formControlName="segundoApellido"
                          readonly
                        >
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="direccion" class="form-label">Dirección registrada</label>
                      <div class="input-group">
                        <span class="input-group-text bg-transparent text-light border-dark">
                          <i class="bi bi-house-door"></i>
                        </span>
                        <input 
                          type="text" 
                          class="form-control bg-dark text-light border-dark" 
                          id="direccion" 
                          formControlName="direccion"
                          readonly
                        >
                      </div>
                    </div>
                    <div class="col-md-6 mb-4">
                      <label for="telefono" class="form-label">Teléfono</label>
                      <div class="input-group">
                        <span class="input-group-text bg-transparent text-light border-dark">
                          <i class="bi bi-telephone"></i>
                        </span>
                        <input 
                          type="text" 
                          class="form-control bg-dark text-light border-dark" 
                          id="telefono" 
                          formControlName="telefono"
                          placeholder="Ingresa tu número de teléfono"
                          [class.is-invalid]="submitted && datosForm.get('telefono')?.invalid"
                        >
                      </div>
                      @if (submitted && datosForm.get('telefono')?.invalid) {
                        <div class="text-danger mt-1">
                          <small><i class="bi bi-exclamation-triangle-fill me-1"></i>Teléfono requerido</small>
                        </div>
                      }
                    </div>
                    <div class="col-md-6 mb-4">
                      <label for="email" class="form-label">Email</label>
                      <div class="input-group">
                        <span class="input-group-text bg-transparent text-light border-dark">
                          <i class="bi bi-envelope"></i>
                        </span>
                        <input 
                          type="email" 
                          class="form-control bg-dark text-light border-dark" 
                          id="email" 
                          formControlName="email"
                          placeholder="Ingresa tu email"
                          [class.is-invalid]="submitted && datosForm.get('email')?.invalid"
                        >
                      </div>
                      @if (submitted && datosForm.get('email')?.invalid) {
                        <div class="text-danger mt-1">
                          <small><i class="bi bi-exclamation-triangle-fill me-1"></i>Email requerido en formato válido</small>
                        </div>
                      }
                    </div>
                  </div>
                }

                <div class="d-flex justify-content-end mt-4">
                  <button type="button" class="btn btn-outline-light btn-lg me-2 px-4" (click)="cancelarCompra()">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                  </button>
                  <button 
                    type="button" 
                    class="btn btn-primary btn-lg px-4" 
                    [disabled]="!dniVerificado || datosForm.invalid" 
                    (click)="siguientePaso()"
                  >
                    Continuar<i class="bi bi-arrow-right ms-2"></i>
                  </button>
                </div>
              </form>
            </div>
          </div>
        }

        <!-- Paso 2: Pago por Yape -->
        @if (currentStep === 2) {
          <div class="card payment-card border-0 shadow-lg animate__animated animate__fadeIn">
            <div class="card-header bg-gradient py-3">
              <h3 class="mb-0"><i class="bi bi-credit-card-fill me-2"></i>Pago con Yape</h3>
            </div>
            <div class="card-body p-4">
              <div class="row align-items-center">
                <div class="col-md-6 text-center mb-4 mb-md-0">
                  <div class="qr-container p-4 bg-white rounded shadow-sm pulse-animation">
                    <img src="qr-pago-yape.jfif" alt="Código QR Yape" class="img-fluid yape-qr" style="max-width: 220px;">
                  </div>
                  <div class="mt-4">
                    <p class="mb-1 text-uppercase fw-light">Monto a pagar</p>
                    <h2 class="text-gradient display-5 mb-3">S/ {{ totalPagar.toFixed(2) }}</h2>
                    <div class="payment-info p-3 rounded">
                      <p class="text-muted small mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Escanea el QR con tu app de Yape para realizar el pago
                      </p>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="payment-form-container">
                    <form [formGroup]="pagoForm">
                      <div class="mb-4">
                        <label for="comprobante" class="form-label">
                          <i class="bi bi-image me-1"></i>
                          Comprobante de pago
                        </label>
                        <div class="custom-file-upload p-3 rounded text-center border border-dark dashed-border">
                          @if (!comprobanteSeleccionado) {
                            <div class="upload-icon mb-2">
                              <i class="bi bi-cloud-arrow-up" style="font-size: 2rem;"></i>
                            </div>
                            <p class="mb-2">Arrastra y suelta tu comprobante aquí</p>
                            <p class="text-muted small">O haz clic para seleccionar</p>
                          }
                          <input 
                            type="file" 
                            class="form-control bg-dark text-light border-dark" 
                            id="comprobante" 
                            (change)="onFileSelected($event)"
                            accept="image/*"
                            [class.is-invalid]="submitted && !comprobanteSeleccionado"
                            [class.d-none]="comprobanteSeleccionado"
                          >
                          @if (comprobanteSeleccionado) {
                            <div class="selected-file-preview">
                              <div class="mb-2">
                                <i class="bi bi-file-earmark-image text-success" style="font-size: 2rem;"></i>
                              </div>
                              <p class="mb-1">Imagen cargada correctamente</p>
                              <button type="button" class="btn btn-sm btn-outline-light mt-2" (click)="eliminarComprobante()">
                                <i class="bi bi-trash me-1"></i>Cambiar imagen
                              </button>
                            </div>
                          }
                        </div>
                        @if (submitted && !comprobanteSeleccionado) {
                          <div class="text-danger mt-2 small animate__animated animate__fadeIn">
                            <i class="bi bi-x-circle-fill me-1"></i> Debes subir un comprobante de pago
                          </div>
                        }
                      </div>

                      <div class="mb-4">
                        <label for="codigoSeguridad" class="form-label">
                          <i class="bi bi-shield-lock me-1"></i>
                          Código de seguridad (3 dígitos)
                        </label>
                        <div class="security-code-container">
                          <div class="input-group">
                            <span class="input-group-text bg-transparent text-light border-dark">
                              <i class="bi bi-lock-fill"></i>
                            </span>
                            <input 
                              type="text" 
                              class="form-control bg-dark text-light border-dark security-code-input" 
                              id="codigoSeguridad" 
                              formControlName="codigoSeguridad"
                              placeholder="Ingresa el código de seguridad" 
                              maxlength="3"
                              [class.is-invalid]="submitted && pagoForm.get('codigoSeguridad')?.invalid"
                            >
                          </div>
                          <div class="security-code-info mt-2">
                            <small class="text-muted">
                              <i class="bi bi-info-circle me-1"></i>
                              Este código es necesario para validar tu pago
                            </small>
                          </div>
                        </div>
                        @if (submitted && pagoForm.get('codigoSeguridad')?.invalid) {
                          <div class="text-danger mt-2 small animate__animated animate__fadeIn">
                            <i class="bi bi-x-circle-fill me-1"></i> El código de seguridad debe tener 3 dígitos
                          </div>
                        }
                      </div>

                      <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-light btn-lg px-4" (click)="volverPaso()">
                          <i class="bi bi-arrow-left me-2"></i>Volver
                        </button>
                        <button 
                          type="button" 
                          class="btn btn-primary btn-lg px-4" 
                          [disabled]="!dniVerificado || datosForm.invalid || !comprobanteSeleccionado" 
                          (click)="enviarPago()"
                        >
                          <i class="bi bi-check2-circle me-2"></i>Finalizar compra
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Paso 4: Estado de la compra -->
        @if (currentStep === 4) {
          <div class="card payment-card border-0 shadow-lg animate__animated animate__fadeIn">
            <div class="card-header bg-gradient py-3">
              <h3 class="mb-0"><i class="bi bi-clock-fill me-2"></i>Estado de la compra</h3>
            </div>
            <div class="card-body p-4 text-center">
              
              @if (cargandoCompra) {
                <div class="loading-state">
                  <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  <h4 class="mb-3">Esperando aprobación...</h4>
                  <p class="text-muted mb-4">Tu compra está siendo revisada por nuestro equipo. Te notificaremos cuando sea procesada.</p>
                  <div class="progress mt-4" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 50%"></div>
                  </div>
                </div>
              }

              @if (mostrarEstadoCompra && estadoCompraActual === 'approved') {
                <div class="success-state">
                  <i class="bi bi-check-circle-fill text-success mb-3" style="font-size: 4rem;"></i>
                  <h4 class="mb-3 text-success">¡Compra Aprobada!</h4>
                  <p class="mb-4">Tu pedido ha sido confirmado y está en proceso.</p>
                  <button class="btn btn-success btn-lg" (click)="limpiarEstadoYRedirigir()">
                    <i class="bi bi-box-arrow-right me-2"></i>Ver mis pedidos
                  </button>
                </div>
              }

              @if (mostrarEstadoCompra && estadoCompraActual === 'rejected') {
                <div class="rejected-state">
                  <i class="bi bi-x-circle-fill text-danger mb-3" style="font-size: 4rem;"></i>
                  <h4 class="mb-3 text-danger">Compra Rechazada</h4>
                  <p class="mb-4">Lo sentimos, no se pudo procesar tu pedido. Por favor intenta nuevamente.</p>
                  <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-outline-primary" (click)="continuarComprando()">
                      <i class="bi bi-arrow-repeat me-2"></i>Intentar de nuevo
                    </button>
                    <button class="btn btn-primary" (click)="volverAInicio()">
                      <i class="bi bi-house-door-fill me-2"></i>Volver al inicio
                    </button>
                  </div>
                </div>
              }

              @if (!cargandoCompra && !mostrarEstadoCompra) {
                <div class="waiting-state">
                  <i class="bi bi-hourglass-split mb-3" style="font-size: 4rem;"></i>
                  <h4 class="mb-3">Compra enviada</h4>
                  <p class="mb-4">Tu compra ha sido enviada para revisión. Te notificaremos cuando sea procesada.</p>
                  <button class="btn btn-primary" (click)="volverAInicio()">
                    <i class="bi bi-house-door-fill me-2"></i>Volver al inicio
                  </button>
                </div>
              }
            </div>
          </div>
        }

        <!-- Paso 3: Confirmación -->
        @if (currentStep === 3) {
  <div class="card payment-card border-0 shadow-lg animate__animated animate__fadeIn">
    <div class="card-header bg-gradient py-3">
      <h3 class="mb-0"><i class="bi bi-bell-fill me-2"></i>Estado de la compra</h3>
    </div>
    <div class="card-body p-4 text-center">
      @if (estadoCompra === 'pendiente') {
        <div class="my-5 py-4">
          <div class="spinner-container mb-4">
            <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
          <h3 class="mb-3">Tu compra está siendo procesada</h3>
          <p class="text-muted mb-0">Estamos verificando tu pago. Este proceso puede tardar unos minutos.</p>
          <div class="progress mt-4" style="height: 6px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 75%"></div>
          </div>
        </div>
      } @else if (estadoCompra === 'aprobada') {
        <div class="my-5 py-4 animate__animated animate__fadeIn">
          <div class="success-checkmark mb-4">
            <div class="check-icon">
              <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
            </div>
          </div>
          <h3 class="mb-3">¡Compra aprobada!</h3>
          <p class="mb-4">Tu pedido ha sido confirmado y está en proceso.</p>
          <div class="order-number-container p-3 rounded mb-4">
            <p class="mb-1 text-muted small">Número de pedido</p>
            <h4 class="mb-0 text-gradient">{{ numeroPedido }}</h4>
          </div>
          <button class="btn btn-primary btn-lg mt-3 px-4" (click)="volverInicio()">
            <i class="bi bi-house-door-fill me-2"></i>Volver al inicio
          </button>
        </div>
      } @else if (estadoCompra === 'rechazada') {
        <div class="my-5 py-4 animate__animated animate__fadeIn">
          <div class="text-danger mb-4">
            <i class="bi bi-x-circle-fill" style="font-size: 5rem;"></i>
          </div>
          <h3 class="mb-3">Compra rechazada</h3>
          <p class="mb-4">Lo sentimos, no se pudo procesar tu pago. Por favor intenta nuevamente.</p>
          <div class="d-flex justify-content-center">
            <button class="btn btn-outline-light btn-lg me-3 px-4" (click)="volverPaso()">
              <i class="bi bi-arrow-repeat me-2"></i>Volver a intentar
            </button>
            <button class="btn btn-primary btn-lg px-4" (click)="volverInicio()">
              <i class="bi bi-house-door-fill me-2"></i>Volver al inicio
            </button>
          </div>
        </div>
      }
    </div>
  </div>
}
      </div>
    </div>
  </div>
</div>

<app-footer-inicio/>